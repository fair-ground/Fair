##############################################################################
#
#    This program is free software: you can redistribute it and/or modify
#    it under the terms of the GNU Affero General Public License as
#    published by the Free Software Foundation, either version 3 of the
#    License, or (at your option) any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU Affero General Public License for more details.
#
#    You should have received a copy of the GNU Affero General Public License
#    along with this program.  If not, see <http://www.gnu.org/licenses/>.
#
##############################################################################

name: Continuous Integration

on:
  push:
    branches: [ main ]
  pull_request_target:
    branches:
      - '*'
  schedule:
    - cron: '0 0,12 * * *'

jobs:
  ci-linux:
    runs-on: ubuntu-22.04
    timeout-minutes: 45

    steps:
      - name: Get swift version
        run: swift --version 

      - name: Checkout
        uses: actions/checkout@v2

      - name: Run fairtool
        run: |
          swift run fairtool version

      - name: Fair Tests
        env:
          FAIRHUB_API_SKIP: true # used by tests to determine load
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: swift test

      - name: Check fairtool formula
        run: |
          eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
          brew install fair-ground/tool/fairtool-head
          brew test fairtool-head
          fairtool-head version

  ci-macOS:
    runs-on: macos-12
    timeout-minutes: 45
    env:
      DEVELOPER_DIR: /Applications/Xcode_14.0.1.app/Contents/Developer
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Run fairtool
        run: xcrun swift run fairtool version

      - name: Fair Tests
        env:
          FAIRHUB_API_SKIP: true # used by tests to determine load
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: xcrun swift test
 
      - name: Test iOS FairCore
        if: false # not configured for testing
        run: xcodebuild test -configuration Debug -scheme "FairCore" -sdk "iphonesimulator" -destination "platform=iOS Simulator,name=iPhone 13" 

      - name: Build iOS FairApp
        run: xcodebuild build -configuration Release -scheme "FairApp" -sdk "iphonesimulator" -destination "platform=iOS Simulator,name=iPhone 13" 

      - name: Test macOS FairCore
        if: false # not configured for testing
        run: xcodebuild test -configuration Debug -scheme "FairCore" -sdk "macosx" -destination "platform=macosx"

      - name: Build macOS FairApp
        run: xcodebuild build -configuration Release -scheme "FairApp" -sdk "macosx" -destination "platform=macosx"

      - name: Check fairtool formula
        run: |
          brew install fair-ground/tool/fairtool-head
          brew test fairtool-head
          fairtool-head version
          #fairtool-head app fork App-Name
          #fairtool-head app config App-Name
          #fairtool-head app release App-Name
          #fairtool-head app integrate App-Name

  ci-windows:
    runs-on: windows-latest
    timeout-minutes: 45
    if: false # disabled for now (missing ZipArchive zlib and CFSwapInt32)

    steps:
      - uses: actions/checkout@v2
      - uses: compnerd/gha-setup-swift@main
        with:
          branch: swift-5.6-release
          tag: 5.6-RELEASE
      - name: Run fairtool
        # A long-standing Windows glitch is the following error (see https://github.com/compnerd/swift-win32/issues/327):
        # TSCUtility/Triple.swift:154: Fatal error: could not determine host triple: malformed
        # So we re-try a few timesâ€¦
        run: |
          swift run fairtool version || swift run fairtool version || swift run fairtool version || swift run fairtool version
      - name: Disable CLI
        # there seems to be a problem with linking a project that
        # contains both a main.swift (fairtool) and test cases
        # (that have their own main() created):
        # lld-link: error: duplicate symbol: main
        # >>> defined at D:\a\Fair\Fair\.build\x86_64-unknown-windows-msvc\debug\FairPackageTests.build\main.swift.o
        # >>> defined at D:\a\Fair\Fair\.build\x86_64-unknown-windows-msvc\debug\FairTool.build\main.swift.o
        # clang: error: linker command failed with exit code 1 (use -v to see invocation)
        run: |
          # swift test on windows fail if there is another main
          # so excise references to FairTool from the package
          mv Package.swift Package.swift.old
          grep -v "FairTool" Package.swift.old > Package.swift
      - name: Fair Tests
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FAIRHUB_API_SKIP: true # used by tests to determine load
        run: |
          swift test 

